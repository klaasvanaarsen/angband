name: DOS Cross-compiler

on:
  push:
    branches: [ master ]
  pull_request:

jobs:
  build:
    name: DOS build and runtime test
    runs-on: ubuntu-latest
    steps:
      - name: Install Build Dependencies
        id: install_depend
        run: |
          sudo apt-get update
          sudo apt-get install make dosbox-x

      - name: Clone Project
        uses: actions/checkout@v4

      - name: Build
        run: |
          archive=djgpp-linux64-gcc1210.tar.bz2
          wget --no-verbose "https://github.com/andrewwutw/build-djgpp/releases/download/v3.3/$archive"
          bunzip2 -c "$archive"| tar -xBf -
          rm "$archive"
          PATH="$PATH":"`pwd`/djgpp/bin"
          cd src
          make -f Makefile.ibm -j$(nproc)

      - name: Prepare DOS runtime environment
        run: |
          mkdir -p dosroot
          cp src/*.exe dosroot/
          cp -r lib dosroot/

      - name: DOS runtime smoke test
        timeout-minutes: 2
        run: |
          cat > dosbox.conf << 'EOF'
          [sdl]
          fullscreen=false

          [dosbox]
          machine=svga_s3

          [cpu]
          core=normal
          cycles=auto

          [autoexec]
          mount c dosroot
          c:
          angband.exe
          exit
          EOF

          dosbox-x -conf dosbox.conf -nogui -exit
